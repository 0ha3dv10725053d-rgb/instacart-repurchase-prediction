# Instacart 再購入予測

# 概要
Instacartの購買履歴データを用いて、
ユーザーが次回注文で商品を再購入するか否かを予測する。

# データの事前処理
products.csv、order.csv、department.csvの欠損値をis null を用いて確認した。
orders.csvでは欠損値はなかったものの、days_since_prior_fielledカルムにおいて""の空文字がが存在していた。
→初回購入と考え、coalesceを用いて0に置換した新カルムを作成した。

# データの結合
orders.csvからeval_set="prior"のデータのみを抽出したテーブルを作成した。(orders2_csv)　32,434,489行

# 商品マスタの作成
続いて部署、棚、商品名の紐付けを行うためにデータ結合を実施した。
商品コードと棚コードを結合した際に48行データが欠如した。(商品コードの変更によるものとして、連結できたデータのみを扱った)
部署コードとの結合では欠損は発生しなかった。(商品マスター完成)

# 購入マスタと商品マスタの結合
商品マスタと購入マスタの結合を試みたが、32,434,489行→18,121,624行と40%以上のデータが欠損した。
これは、購入履歴に存在する product_id の一部が
商品マスタに存在しないことが原因であると考えた。
分析対象の購入データを可能な限り保持するため、
INNER JOIN ではなく LEFT JOIN を採用した。left　joinに変更しデータを保持した。
* 今後商品属性（部署・棚・商品名）を用いた分析は、
商品マスタと紐づいたデータに限定して実施する。
マスタ未登録商品については、集計・特徴量作成の段階で適切に除外または補足説明を行う。
# 再購入されやすい商品は何か？
再購入率を商品ごとに探るに当たり、購入数が少ない商品を入れると標準偏差のブレが大きくなると考えた。
再購入率は0/1データであるため、
推定値の標準偏差は √(p(1-p)/n) で評価できる。
最悪ケース（p=0.5）において標準偏差を0.1以下に抑えるには
25回以上の購入が必要となる。
本分析ではEDA段階の実務的基準として、
これに近い25回以上を閾値として採用した。
商品ごとの再購入率、商品×部門ごとの再購入率の粒度で分析を行った。
仮説形成のために、適時tableauを用いてデータを可視化した。

# 再購入しやすい人は？
分析の結果、購入回数が少ないユーザーでは再購入率の分散が大きく、
嗜好（購入部門）の影響を強く受ける一方、
購入回数が多いユーザーでは再購入率が高く安定する傾向が見られた。
このことから、再購入は「ユーザーの購買経験量」と「部門嗜好」の
両方に依存すると仮定した。

# ロジスティクス回帰分析
上記の仮説に基づき、以下を説明変数とした。
ユーザー × 部門の購入数
ユーザー × 部門の再購入率
ユーザーの総購入回数
購入間隔
目的変数を再購入の有無とし、ロジスティクス回帰分析を実施した。

# ロジスティクス回帰分析_結果
AUCは0.772
各係数のオッズ比を比較する中でユーザー×部門購入回数：0.987	ユーザー×部門再購入率：3.361	ユーザーの総購入回数：0.996818  購入間隔：1.0065895 であり、部門再購入率の影響が大きすぎる可能性が示唆された。
そのため、実際に当該変数を除外してモデルを再構築したところ、AUCの低下は限定的であり、再購入行動は購入回数・購入スパン・部門嗜好といった行動特徴量によって十分に説明可能であることが示唆された。
AUC:0.707　各オッズ比は総購入数：1.49824265,ユーザー×部門別購入数：1.52645235, 購入間隔0.949278
再購入率を含むモデルでは一部の変数でオッズ比が1を下回ったが、これは再購入率が他の行動変数を強く要約した代理変数であり、各係数が「再購入率が一定である条件下での限界効果」を表すためと考えられる。
そのため、再購入率を含むモデルは予測精度は高い一方で、行動変数との共線性により係数解釈が難しくなるため、事業施策への落とし込みを重視して再購入率を除外したモデルから事業における施策を検討した。

 # 施策
ユーザーの総購入数(オッズ比=1.50）およびユーザー×部門購入数（オッズ比=1.53）が再購入確率を高めることが確認された。
これは「特定部門での購入経験」が再購入を促進する要因であることを示している。
また、購入間隔はオッズ比が1を下回っており(オッズ比=0.95)、購入間隔が伸びるほど再購入確率が低下する傾向が見られた。
そのため、初期購買段階において部門嗜好に基づいたクーポン配布やリマインド施策を実施し、購入スパンを短縮することが、再購入率向上に有効であると考えられる。

